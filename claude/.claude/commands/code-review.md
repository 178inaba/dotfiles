---
description: コード差分を詳細にレビュー
---

# /code-review

コード差分を経験豊富なシニアエンジニアとして、本番運用を考慮しながら詳細にレビューし、Approve可能か判断

## 使用方法
```
/code-review [base-branch] [--issue ISSUE_NUMBER] [--staged]
```

**引数**:
- `base-branch`: 比較対象のブランチ（省略時: `git symbolic-ref refs/remotes/origin/HEAD` で自動判定）
- `--issue ISSUE_NUMBER`: 指定したIssue要件を満たしているか確認
- `--staged`: 未コミットの差分をレビュー（`git diff`を使用）

**例**:
```
/code-review                              # デフォルトブランチとの差分をレビュー
/code-review main                         # mainブランチとの差分をレビュー
/code-review origin/feature-auth          # feature-authブランチとの差分をレビュー
/code-review main --issue 123             # Issue #123の要件も確認
/code-review --staged                     # 未コミットの差分をレビュー
/code-review --issue 456 --staged         # 未コミット差分をIssue #456の観点で確認
```

## 実行内容

### 1. 差分取得と確認
- `--staged`が指定されている場合:
  - `git diff` で未コミットの差分を取得
- 指定されていない場合:
  - ベースブランチの決定: 引数がなければ `git symbolic-ref refs/remotes/origin/HEAD` で自動判定
  - 差分が大きい場合は `git diff <base-branch>...HEAD --name-only` で変更ファイル一覧を先に確認
  - 各ファイルを `git diff <base-branch>...HEAD <ファイル名>` で個別に確認
  - 全体を把握してからレビュー評価を実施

**重要原則**:
- 全差分確認: 必ず全ての変更内容を確認してから評価する
- 段階的確認: ファイル一覧 → 個別差分 → 全体評価の順で進める
- 部分的判断禁止: 一部の差分や最初の部分だけを見て結論を出さない
- 見落とし防止: 特に新規追加ファイルや定数・インターフェース変更は必ず確認する

### 2. Issue情報取得（`--issue`指定時）
- `gh issue view <ISSUE_NUMBER>` でIssue内容を取得
- 要件・仕様を確認

### 3. レビュー実行
以下の観点から詳細にレビュー:

#### 基本観点
- [ ] コードの品質（可読性、保守性）
- [ ] バグや潜在的な問題の有無
- [ ] セキュリティリスク（OWASP Top 10等）
- [ ] パフォーマンスへの影響
- [ ] テストコードの妥当性
- [ ] エラーハンドリングの適切性
- [ ] 命名規則やコーディングスタイルの一貫性

#### 本番運用観点
- [ ] 本番環境でのログ・監視は十分か
- [ ] ロールバック可能な実装か
- [ ] データベースマイグレーションの安全性
- [ ] エッジケースや境界値の考慮
- [ ] 障害時の影響範囲と復旧方法
- [ ] スケーラビリティへの影響

#### Issue指定時の追加観点
- [ ] Issue要件を満たしているか
- [ ] 仕様から逸脱していないか
- [ ] 関連する要件がすべて実装されているか

### 4. レビュー結果出力
以下の形式で出力:

```markdown
## レビュー結果

### 総合評価
- Approve可能 / 修正が必要 / 要議論

### 良い点
- ...

### 指摘事項
#### 必須修正
- ...

#### 推奨修正
- ...

#### 質問・確認事項
- ...

### Issue要件の充足状況（--issue指定時のみ）
- ...
```

## 注意事項
- ベースブランチが存在しない場合はエラーを通知
- Issue番号が不正な場合はエラーを通知
- デフォルトブランチの自動判定が失敗した場合は `origin/main` をフォールバック
